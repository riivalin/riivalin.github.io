---
layout: post
title: "[SQL] Commit & Rollback"
date: 2011-04-18 05:09:00 +0800
categories: [Notes,SQL]
tags: [commit,rollback,transaction]
---

||Oracle|SQL Server|
|:---|:---|:---|
|開始交易|無|Begin Tran (Transaction)|
|確定結束|Commit|Commit Tran (Transaction)|
|放棄結束|Rollback|Rollback Tran (Transaction)|


- `BEGIN TRANSACTION` ：啟動交易。
- `COMMIT TRANSACTION` ：如果沒有發生錯誤，可用來順利結束交易。
- `ROLLBACK TRANSACTION` ：發生錯誤時，用來清除交易。交易所修改的一切資料都會回到交易啟動時的狀態。

     
## 範例：Rollback 錯誤的巢狀交易

在處理交易異動`Transaction`的時候，一般都用 `RollBack Transaction`放棄結束異動(=回到異動資料前的狀態)，`RollBack Transaction`會回復所有`begin tran`包括已經提交的異動和未提交的異動。

> 巢狀交易時，`ROLLBACK` 不管在哪一層，它會 `ROLLBACK` 巢狀中的所有交易     

> 若是外部交易被 `Rollback` ，則不管內部交易是否個別被 `Commit` ，所有的內部交易都會被 `Rollback` 。

```sql
begin tran
    begin tran
        update Product set ProductName = 'DVDROM-123' where ID = 14
    commit tran --認可異動- 原本能夠成功更新的這段語法，會被後被ROLLBACK 給回復
    update Product set ProductName = 'DVDROM-456' where ID = 13
rollback tran --會回復BEGIN TRANSACTION之後的所有異動，所以兩筆資料都不會被update
```

> 用`@@TRANCOUNT`可以檢查是否已經打開一個交易異動`Begin Tran`。     
> `SELECT @@TRANCOUNT`结果是`1`，意思是目前連線已經開啟了一個交易異動`Begin Tran`。 `0`的意思是目前沒有交易異動，一個大於1的數的意思是有巢狀交易。      
> `@@TRANCOUNT`的值是`1`,這個時候必須提交或回復交易，不然等到語句結束，表仍然是鎖住，會造成阻塞。



[MSDN -  BEGIN TRANSACTION (Transact-SQL)](https://learn.microsoft.com/zh-tw/sql/t-sql/language-elements/begin-transaction-transact-sql?view=sql-server-ver15#general-remarks)      
[@@TRANCOUNT (檢視目前啟用 BEGIN TRAN 的數量)](https://riivalin.github.io/posts/2011/04/sql-52/)        
[Transactions](http://vito-note.blogspot.com/2013/05/transactions.html)
